import{_ as i,c as a,a as n,o as l}from"./app-D6s_7T7O.js";const e="/doc2show/img/33/1.png",p="/doc2show/img/33/2.png",t={};function h(k,s){return l(),a("div",null,s[0]||(s[0]=[n('<p>大家好，我是村长！</p><p>非常高兴大家跟我一起走到这里，眼看就要大功告成了，我们撒花庆祝一下！</p><p>本讲我们将项目部署上线，涉及以下内容：</p><ul><li><p>docker 镜像制作；</p></li><li><p>docker-compose 编排镜像；</p></li><li><p>本地部署测试；</p></li><li><p>部署到华为云；</p></li><li><p>Nginx 反代。</p></li></ul><h2 id="整体架构" tabindex="-1"><a class="header-anchor" href="#整体架构"><span>整体架构</span></a></h2><p>我们将制作一个 Docker 镜像把 Nuxt 作为 Web 服务一部分封装起来，然后和原先开发环境中的 MySQL 和 adminer 编排在一起。</p><p>然后我们连接服务器，克隆项目之后启动 docker-compose。</p><p>最后配置 Nginx 对外暴露服务。</p><p><img src="'+e+`" alt=""></p><h2 id="制作-docker-镜像" tabindex="-1"><a class="header-anchor" href="#制作-docker-镜像"><span>制作 Docker 镜像</span></a></h2><p>首先制作一个 Docker 镜像，提供 Node 环境，安装依赖，启动 Nuxt 服务。</p><p>Dockerfile：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #Dockerfile</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #制定node镜像的版本</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   FROM</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node:18-alpine</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #移动当前目录下面的文件到app目录下</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   ADD</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> .</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /app/</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #进入到app目录下面，类似cd</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   WORKDIR</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /app</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #安装依赖</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   RUN</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> npm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> registry</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://registry.npm.taobao.org/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;&amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> \\</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       npm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> i</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #对外暴露的端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   EXPOSE</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3000</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #程序启动脚本</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   CMD</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">npm</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">start</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加一个 start 命令，package.json</p><div class="language-javascript line-numbers-mode" data-ext="javascript" data-title="javascript"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">      &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">scripts</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">start</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">nuxt start</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="制作-docker-compose-编排" tabindex="-1"><a class="header-anchor" href="#制作-docker-compose-编排"><span>制作 Docker-Compose 编排</span></a></h2><p>引入前面制作的镜像，同时还要编排启动顺序，保证数据库最先启动，然后才是 adminer 和 Nuxt 项目。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    version:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3.7</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    services:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      mysql_db_container:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        image:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql:latest</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        command</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --default-authentication-plugin=mysql_native_password</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        environment:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          MYSQL_ROOT_PASSWORD:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rootpassword</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # root账号密码</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">          #MYSQL_ROOT_PASSWORD: \${MYSQL_ROOT_PASSWORD} # root账号密码</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        ports:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 3306:3306</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        volumes:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql_db_data_container:/var/lib/mysql</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        healthcheck:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          test</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CMD</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">mysqladmin</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ping</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-h</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">localhost</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">]</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          interval:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 30s</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          timeout:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10s</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          retries:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      adminer_container:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        image:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> adminer:latest</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        environment:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          ADMINER_DEFAULT_SERVER:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql_db_container</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        ports:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 8080:8080</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      nuxt_app_container:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        container_name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nuxt_app</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        restart:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> always</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #构建容器</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        build:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          context:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> .</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">          # 自动输入Y防止造成编译卡死</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          args:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-y</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        ports:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3004:3000</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        environment:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          DATABASE_URL:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql://root:rootpassword@mysql_db_container:3306/ycxt</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          NUXT_BASE_URL:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://jsonplaceholder.typicode.com</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          JSON_SECRET:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> thisisjsonsecret</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        command</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          /bin/sh</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -c</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">npm run migrate &amp;&amp; npm run build &amp;&amp; npm start</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        depends_on:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          mysql_db_container:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            condition:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service_healthy</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    volumes:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      mysql_db_data_container:</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="在开发机测试" tabindex="-1"><a class="header-anchor" href="#在开发机测试"><span>在开发机测试</span></a></h2><p>本机先测试一下：</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span></span></span>
<span class="line"><span> # 后台启动</span></span>
<span class="line"><span> docker-compose up -d</span></span>
<span class="line"><span> </span></span>
<span class="line"><span> # 如果之前本地曾执行过，那么执行下面强制容器刷新</span></span>
<span class="line"><span> docker-compose up -d --force-recreate --build</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果你和我一样遇到了以下错误：</p><blockquote><pre><code>------
 &gt; [internal] load metadata for docker.io/library/node:18-alpine:
------
failed to solve: rpc error: code = Unknown desc = failed to solve with
</code></pre><p>frontend dockerfile.v0: failed to create LLB definition: unexpected status code [manifests 18-alpine]: 403 Forbidden</p></blockquote><p>请执行以下命令手动安装 node:18-alpine，然后再执行</p><blockquote><pre><code>docker pull node:18-alpine
</code></pre></blockquote><h2 id="部署到华为云" tabindex="-1"><a class="header-anchor" href="#部署到华为云"><span>部署到华为云</span></a></h2><p>接下来连接华为云，克隆项目，启动 Docker 镜像。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   # 登录华为云</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   # 需要提前设置好秘钥</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   ssh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> root@123.249.115.108</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">   </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   # 克隆项目代码</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">   cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> source</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   git</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> clone</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> git@github.com:57code/nuxt-app.git</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">   </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   # 进入项目目录</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">   cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nuxt-app</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">   </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   # 启动docker</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   docker-compose</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> up</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -d</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果创建过，则先停止 docker-compose 并删除目录：</p><blockquote><pre><code># 删除目录
cd source/nuxt-app
docker-compose down
cd ..
rm -rf nuxt-app
</code></pre></blockquote><h2 id="开放端口" tabindex="-1"><a class="header-anchor" href="#开放端口"><span>开放端口</span></a></h2><p>如果你的服务器没有任何 Web 服务，则可以使用 80 端口（替换截图中的 3004 为 80），从而避免下面的开放端口操作：</p><p><img src="`+p+`" alt=""></p><p>前面我对外暴露端口号是 3004，原因是服务器已经有 3 个应用占据了 3000~3003。所以如果我现在想要访问，就需要登上云服务商控制台开放 3004 端口（一般在 ECS 安全组配置），之后再用 IP + 端口访问：</p><pre><code>http://123.249.115.108:3004
</code></pre><h2 id="nginx-配置反向代理" tabindex="-1"><a class="header-anchor" href="#nginx-配置反向代理"><span>Nginx 配置反向代理</span></a></h2><p>显然大家不想这样访问，因此我们再配置一下 Nginx，如果你还没装，则需要安装一下，不会的话可以百度。这里配置 Nginx 主要目标有两个：</p><ul><li><p>配置一个域名避免输入IP；</p></li><li><p>代理到 3004 避免开放 3004 端口。</p></li></ul><p>域名解析也需要去云服务商控制台配置，如果你没有域名可以直接使用 IP 地址。</p><p>下面是服务器上的 Nginx 配置目录：/etc/nginx/sites-enabled/nuxt，可以用 vi 编辑如下内容：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     listen</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 80</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     server_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nuxt3.cn</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">             proxy_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  http://localhost:3004/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">             proxy_redirect</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     off</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">             proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Host</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">             $host</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">             proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   X-Real-IP</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        $remote_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">             proxy_set_header</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   X-Forwarded-For</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  $proxy_add_x_forwarded_for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">     }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重新加载以使 Nginx 配置生效：</p><pre><code># 测试配置文件是否正确
nginx -t 

# 重启nginx服务
nginx -s reload
</code></pre>`,43)]))}const r=i(t,[["render",h],["__file","index.html.vue"]]),c=JSON.parse(`{"path":"/nuxt3/vctj142k/","title":"33-项目部署","lang":"zh-CN","frontmatter":{"title":"33-项目部署","author":"Your name","createTime":"2024/07/29 16:11:51","permalink":"/nuxt3/vctj142k/","head":[["script",{"id":"check-dark-mode"},";(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();"],["script",{"id":"check-mac-os"},"document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))"]]},"headers":[{"level":2,"title":"整体架构","slug":"整体架构","link":"#整体架构","children":[]},{"level":2,"title":"制作 Docker 镜像","slug":"制作-docker-镜像","link":"#制作-docker-镜像","children":[]},{"level":2,"title":"制作 Docker-Compose 编排","slug":"制作-docker-compose-编排","link":"#制作-docker-compose-编排","children":[]},{"level":2,"title":"在开发机测试","slug":"在开发机测试","link":"#在开发机测试","children":[]},{"level":2,"title":"部署到华为云","slug":"部署到华为云","link":"#部署到华为云","children":[]},{"level":2,"title":"开放端口","slug":"开放端口","link":"#开放端口","children":[]},{"level":2,"title":"Nginx 配置反向代理","slug":"nginx-配置反向代理","link":"#nginx-配置反向代理","children":[]}],"readingTime":{"minutes":3.34,"words":1001},"git":{"createdTime":1722241276000,"updatedTime":1728783252000,"contributors":[{"name":"xxdl","email":"xxdl@xxdl.top","commits":2},{"name":"DengChang","email":"85365","commits":1}]},"filePathRelative":"notes/nuxt3/33-项目部署.md"}`);export{r as comp,c as data};
